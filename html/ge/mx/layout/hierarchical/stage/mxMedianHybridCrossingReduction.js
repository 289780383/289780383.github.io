function mxMedianHybridCrossingReduction(e){this.layout=e}function MedianCellSorter(){}mxMedianHybridCrossingReduction.prototype=new mxHierarchicalLayoutStage,mxMedianHybridCrossingReduction.prototype.constructor=mxMedianHybridCrossingReduction,mxMedianHybridCrossingReduction.prototype.layout=null,mxMedianHybridCrossingReduction.prototype.maxIterations=24,mxMedianHybridCrossingReduction.prototype.nestedBestRanks=null,mxMedianHybridCrossingReduction.prototype.currentBestCrossings=0,mxMedianHybridCrossingReduction.prototype.iterationsWithoutImprovement=0,mxMedianHybridCrossingReduction.prototype.maxNoImprovementIterations=2,mxMedianHybridCrossingReduction.prototype.execute=function(e){var r=this.layout.getModel();this.nestedBestRanks=[];for(var n=0;n<r.ranks.length;n++)this.nestedBestRanks[n]=r.ranks[n].slice();var t=0,a=this.calculateCrossings(r);for(n=0;n<this.maxIterations&&t<this.maxNoImprovementIterations;n++){this.weightedMedian(n,r),this.transpose(n,r);var o=this.calculateCrossings(r);if(o<a){a=o,t=0;for(var i=0;i<this.nestedBestRanks.length;i++)for(var s=r.ranks[i],l=0;l<s.length;l++){var u=s[l];this.nestedBestRanks[i][u.getGeneralPurposeVariable(i)]=u}}else{t++;for(i=0;i<this.nestedBestRanks.length;i++)for(s=r.ranks[i],l=0;l<s.length;l++){(u=s[l]).setGeneralPurposeVariable(i,l)}}if(0==a)break}var d=[],g=[];for(n=0;n<r.maxRank+1;n++)g[n]=[],d[n]=g[n];for(n=0;n<this.nestedBestRanks.length;n++)for(i=0;i<this.nestedBestRanks[n].length;i++)g[n].push(this.nestedBestRanks[n][i]);r.ranks=d},mxMedianHybridCrossingReduction.prototype.calculateCrossings=function(e){for(var r=e.ranks.length,n=0,t=1;t<r;t++)n+=this.calculateRankCrossing(t,e);return n},mxMedianHybridCrossingReduction.prototype.calculateRankCrossing=function(e,r){for(var n=0,t=r.ranks[e],a=r.ranks[e-1],o=[],i=0;i<t.length;i++){for(var s=t[i],l=s.getGeneralPurposeVariable(e),u=s.getPreviousLayerConnectedCells(e),d=[],g=0;g<u.length;g++){var p=u[g].getGeneralPurposeVariable(e-1);d.push(p)}d.sort(function(e,r){return e-r}),o[l]=d}var c=[];for(i=0;i<o.length;i++)c=c.concat(o[i]);for(var h=1;h<a.length;)h<<=1;var f=2*h-1;h-=1;var y=[];for(i=0;i<f;++i)y[i]=0;for(i=0;i<c.length;i++){var m=c[i]+h;for(++y[m];m>0;)m%2&&(n+=y[m+1]),++y[m=m-1>>1]}return n},mxMedianHybridCrossingReduction.prototype.transpose=function(e,r){for(var n=!0,t=0;n&&t++<10;){var a=e%2==1&&t%2==1;n=!1;for(var o=0;o<r.ranks.length;o++){for(var i=r.ranks[o],s=[],l=0;l<i.length;l++){var u=i[l],d=u.getGeneralPurposeVariable(o);d<0&&(d=l),s[d]=u}var g=null,p=null,c=null,h=null,f=null,y=null,m=null,C=null,v=null,R=null;for(l=0;l<i.length-1;l++){if(0==l){g=(v=s[l]).getNextLayerConnectedCells(o),p=v.getPreviousLayerConnectedCells(o),f=[],y=[];for(var b=0;b<g.length;b++)f[b]=g[b].getGeneralPurposeVariable(o+1);for(b=0;b<p.length;b++)y[b]=p[b].getGeneralPurposeVariable(o-1)}else g=c,p=h,f=m,y=C,v=R;c=(R=s[l+1]).getNextLayerConnectedCells(o),h=R.getPreviousLayerConnectedCells(o),m=[],C=[];for(b=0;b<c.length;b++)m[b]=c[b].getGeneralPurposeVariable(o+1);for(b=0;b<h.length;b++)C[b]=h[b].getGeneralPurposeVariable(o-1);var k=0,x=0;for(b=0;b<f.length;b++)for(var M=0;M<m.length;M++)f[b]>m[M]&&k++,f[b]<m[M]&&x++;for(b=0;b<y.length;b++)for(M=0;M<C.length;M++)y[b]>C[M]&&k++,y[b]<C[M]&&x++;if(x<k||x==k&&a){var V=v.getGeneralPurposeVariable(o);v.setGeneralPurposeVariable(o,R.getGeneralPurposeVariable(o)),R.setGeneralPurposeVariable(o,V),c=g,h=p,m=f,C=y,R=v,a||(n=!0)}}}}},mxMedianHybridCrossingReduction.prototype.weightedMedian=function(e,r){var n=e%2==0;if(n)for(var t=r.maxRank-1;t>=0;t--)this.medianRank(t,n);else for(t=1;t<r.maxRank;t++)this.medianRank(t,n)},mxMedianHybridCrossingReduction.prototype.medianRank=function(e,r){for(var n=this.nestedBestRanks[e].length,t=[],a=[],o=0;o<n;o++){var i,s,l=this.nestedBestRanks[e][o],u=new MedianCellSorter;u.cell=l,i=r?l.getNextLayerConnectedCells(e):l.getPreviousLayerConnectedCells(e),s=r?e+1:e-1,null!=i&&0!=i.length?(u.medianValue=this.medianValue(i,s),t.push(u)):a[l.getGeneralPurposeVariable(e)]=!0}t.sort(MedianCellSorter.prototype.compare);for(o=0;o<n;o++){if(null==a[o])(l=t.shift().cell).setGeneralPurposeVariable(e,o)}},mxMedianHybridCrossingReduction.prototype.medianValue=function(e,r){for(var n=[],t=0,a=0;a<e.length;a++){var o=e[a];n[t++]=o.getGeneralPurposeVariable(r)}if(n.sort(function(e,r){return e-r}),t%2==1)return n[Math.floor(t/2)];if(2==t)return(n[0]+n[1])/2;var i=t/2,s=n[i-1]-n[0],l=n[t-1]-n[i];return(n[i-1]*l+n[i]*s)/(s+l)},MedianCellSorter.prototype.medianValue=0,MedianCellSorter.prototype.cell=!1,MedianCellSorter.prototype.compare=function(e,r){return null!=e&&null!=r?r.medianValue>e.medianValue?-1:r.medianValue<e.medianValue?1:0:0};