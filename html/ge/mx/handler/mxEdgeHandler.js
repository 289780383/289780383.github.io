function mxEdgeHandler(t){null!=t&&(this.state=t,this.init(),this.escapeHandler=mxUtils.bind(this,function(e,n){var i=null!=this.index;this.reset(),i&&this.graph.cellRenderer.redraw(this.state,!1,t.view.isRendering())}),this.state.view.graph.addListener(mxEvent.ESCAPE,this.escapeHandler))}mxEdgeHandler.prototype.graph=null,mxEdgeHandler.prototype.state=null,mxEdgeHandler.prototype.marker=null,mxEdgeHandler.prototype.constraintHandler=null,mxEdgeHandler.prototype.error=null,mxEdgeHandler.prototype.shape=null,mxEdgeHandler.prototype.bends=null,mxEdgeHandler.prototype.labelShape=null,mxEdgeHandler.prototype.cloneEnabled=!0,mxEdgeHandler.prototype.addEnabled=!1,mxEdgeHandler.prototype.removeEnabled=!1,mxEdgeHandler.prototype.dblClickRemoveEnabled=!1,mxEdgeHandler.prototype.mergeRemoveEnabled=!1,mxEdgeHandler.prototype.straightRemoveEnabled=!1,mxEdgeHandler.prototype.virtualBendsEnabled=!1,mxEdgeHandler.prototype.virtualBendOpacity=20,mxEdgeHandler.prototype.parentHighlightEnabled=!1,mxEdgeHandler.prototype.preferHtml=!1,mxEdgeHandler.prototype.allowHandleBoundsCheck=!0,mxEdgeHandler.prototype.snapToTerminals=!1,mxEdgeHandler.prototype.handleImage=null,mxEdgeHandler.prototype.tolerance=0,mxEdgeHandler.prototype.outlineConnect=!1,mxEdgeHandler.prototype.manageLabelHandle=!1,mxEdgeHandler.prototype.init=function(){if(this.graph=this.state.view.graph,this.marker=this.createMarker(),this.constraintHandler=new mxConstraintHandler(this.graph),this.points=[],this.abspoints=this.getSelectionPoints(this.state),this.shape=this.createSelectionShape(this.abspoints),this.shape.dialect=this.graph.dialect!=mxConstants.DIALECT_SVG?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG,this.shape.init(this.graph.getView().getOverlayPane()),this.shape.pointerEvents=!1,this.shape.setCursor(mxConstants.CURSOR_MOVABLE_EDGE),mxEvent.redirectMouseEvents(this.shape.node,this.graph,this.state),this.preferHtml=null!=this.state.text&&this.state.text.node.parentNode==this.graph.container,!this.preferHtml){var t=this.state.getVisibleTerminalState(!0);if(null!=t&&(this.preferHtml=null!=t.text&&t.text.node.parentNode==this.graph.container),!this.preferHtml){var e=this.state.getVisibleTerminalState(!1);null!=e&&(this.preferHtml=null!=e.text&&e.text.node.parentNode==this.graph.container)}}if(this.parentHighlightEnabled){var n=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(n)){var i=this.graph.view.getState(n);null!=i&&(this.parentHighlight=this.createParentHighlightShape(i),this.parentHighlight.dialect=this.graph.dialect!=mxConstants.DIALECT_SVG?mxConstants.DIALECT_VML:mxConstants.DIALECT_SVG,this.parentHighlight.pointerEvents=!1,this.parentHighlight.rotation=Number(i.style[mxConstants.STYLE_ROTATION]||"0"),this.parentHighlight.init(this.graph.getView().getOverlayPane()))}}(this.graph.getSelectionCount()<mxGraphHandler.prototype.maxCells||mxGraphHandler.prototype.maxCells<=0)&&(this.bends=this.createBends(),this.isVirtualBendsEnabled()&&(this.virtualBends=this.createVirtualBends())),this.label=new mxPoint(this.state.absoluteOffset.x,this.state.absoluteOffset.y),this.labelShape=this.createLabelHandleShape(),this.initBend(this.labelShape),this.labelShape.setCursor(mxConstants.CURSOR_LABEL_HANDLE),this.customHandles=this.createCustomHandles(),this.redraw()},mxEdgeHandler.prototype.createCustomHandles=function(){return null},mxEdgeHandler.prototype.isVirtualBendsEnabled=function(t){return this.virtualBendsEnabled&&(null==this.state.style[mxConstants.STYLE_EDGE]||this.state.style[mxConstants.STYLE_EDGE]==mxConstants.NONE||1==this.state.style[mxConstants.STYLE_NOEDGESTYLE])&&"arrow"!=mxUtils.getValue(this.state.style,mxConstants.STYLE_SHAPE,null)},mxEdgeHandler.prototype.isCellEnabled=function(t){return!0},mxEdgeHandler.prototype.isAddPointEvent=function(t){return mxEvent.isShiftDown(t)},mxEdgeHandler.prototype.isRemovePointEvent=function(t){return mxEvent.isShiftDown(t)},mxEdgeHandler.prototype.getSelectionPoints=function(t){return t.absolutePoints},mxEdgeHandler.prototype.createParentHighlightShape=function(t){var e=new mxRectangleShape(t,null,this.getSelectionColor());return e.strokewidth=this.getSelectionStrokeWidth(),e.isDashed=this.isSelectionDashed(),e},mxEdgeHandler.prototype.createSelectionShape=function(t){var e=new this.state.shape.constructor;return e.outline=!0,e.apply(this.state),e.isDashed=this.isSelectionDashed(),e.stroke=this.getSelectionColor(),e.isShadow=!1,e},mxEdgeHandler.prototype.getSelectionColor=function(){return mxConstants.EDGE_SELECTION_COLOR},mxEdgeHandler.prototype.getSelectionStrokeWidth=function(){return mxConstants.EDGE_SELECTION_STROKEWIDTH},mxEdgeHandler.prototype.isSelectionDashed=function(){return mxConstants.EDGE_SELECTION_DASHED},mxEdgeHandler.prototype.isConnectableCell=function(t){return!0},mxEdgeHandler.prototype.getCellAt=function(t,e){return this.outlineConnect?null:this.graph.getCellAt(t,e)},mxEdgeHandler.prototype.createMarker=function(){var t=new mxCellMarker(this.graph),e=this;return t.getCell=function(t){var n=mxCellMarker.prototype.getCell.apply(this,arguments);if(n!=e.state.cell&&null!=n||null==e.currentPoint||(n=e.graph.getCellAt(e.currentPoint.x,e.currentPoint.y)),null!=n&&!this.graph.isCellConnectable(n)){var i=this.graph.getModel().getParent(n);this.graph.getModel().isVertex(i)&&this.graph.isCellConnectable(i)&&(n=i)}var s=e.graph.getModel();return(this.graph.isSwimlane(n)&&null!=e.currentPoint&&this.graph.hitsSwimlaneContent(n,e.currentPoint.x,e.currentPoint.y)||!e.isConnectableCell(n)||n==e.state.cell||null!=n&&!e.graph.connectableEdges&&s.isEdge(n)||s.isAncestor(e.state.cell,n))&&(n=null),this.graph.isCellConnectable(n)||(n=null),n},t.isValidState=function(t){var n=e.graph.getModel(),i=e.graph.view.getTerminalPort(t,e.graph.view.getState(n.getTerminal(e.state.cell,!e.isSource)),!e.isSource),s=null!=i?i.cell:null,l=e.isSource?t.cell:s,a=e.isSource?s:t.cell;return e.error=e.validateConnection(l,a),null==e.error},t},mxEdgeHandler.prototype.validateConnection=function(t,e){return this.graph.getEdgeValidationError(this.state.cell,t,e)},mxEdgeHandler.prototype.createBends=function(){for(var t=this.state.cell,e=[],n=0;n<this.abspoints.length;n++)if(this.isHandleVisible(n)){var i=0==n,s=n==this.abspoints.length-1,l=i||s;(l||this.graph.isCellBendable(t))&&mxUtils.bind(this,function(t){var i=this.createHandleShape(t);this.initBend(i,mxUtils.bind(this,mxUtils.bind(this,function(){this.dblClickRemoveEnabled&&this.removePoint(this.state,t)}))),this.isHandleEnabled(n)&&i.setCursor(l?mxConstants.CURSOR_TERMINAL_HANDLE:mxConstants.CURSOR_BEND_HANDLE),e.push(i),l||(this.points.push(new mxPoint(0,0)),i.node.style.visibility="hidden")})(n)}return e},mxEdgeHandler.prototype.createVirtualBends=function(){var t=this.state.cell,e=(this.abspoints[0],[]);if(this.graph.isCellBendable(t))for(var n=1;n<this.abspoints.length;n++)mxUtils.bind(this,function(t){this.initBend(t),t.setCursor(mxConstants.CURSOR_VIRTUAL_BEND_HANDLE),e.push(t)})(this.createHandleShape());return e},mxEdgeHandler.prototype.isHandleEnabled=function(t){return!0},mxEdgeHandler.prototype.isHandleVisible=function(t){var e=this.state.getVisibleTerminalState(!0),n=this.state.getVisibleTerminalState(!1),i=this.graph.getCellGeometry(this.state.cell);return(null!=i?this.graph.view.getEdgeStyle(this.state,i.points,e,n):null)!=mxEdgeStyle.EntityRelation||0==t||t==this.abspoints.length-1},mxEdgeHandler.prototype.createHandleShape=function(t){if(null!=this.handleImage){var e=new mxImageShape(new mxRectangle(0,0,this.handleImage.width,this.handleImage.height),this.handleImage.src);return e.preserveImageAspect=!1,e}var n=mxConstants.HANDLE_SIZE;return this.preferHtml&&(n-=1),new mxRectangleShape(new mxRectangle(0,0,n,n),mxConstants.HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)},mxEdgeHandler.prototype.createLabelHandleShape=function(){if(null!=this.labelHandleImage){var t=new mxImageShape(new mxRectangle(0,0,this.labelHandleImage.width,this.labelHandleImage.height),this.labelHandleImage.src);return t.preserveImageAspect=!1,t}var e=mxConstants.LABEL_HANDLE_SIZE;return new mxRectangleShape(new mxRectangle(0,0,e,e),mxConstants.LABEL_HANDLE_FILLCOLOR,mxConstants.HANDLE_STROKECOLOR)},mxEdgeHandler.prototype.initBend=function(t,e){this.preferHtml?(t.dialect=mxConstants.DIALECT_STRICTHTML,t.init(this.graph.container)):(t.dialect=this.graph.dialect!=mxConstants.DIALECT_SVG?mxConstants.DIALECT_MIXEDHTML:mxConstants.DIALECT_SVG,t.init(this.graph.getView().getOverlayPane())),mxEvent.redirectMouseEvents(t.node,this.graph,this.state,null,null,null,e)},mxEdgeHandler.prototype.getHandleForEvent=function(t){var e=mxEvent.isMouseEvent(t.getEvent())?1:this.tolerance,n=this.allowHandleBoundsCheck&&e>0?new mxRectangle(t.getGraphX()-e,t.getGraphY()-e,2*e,2*e):null,i=null,s=null;function l(e){if(null!=e&&null!=e.node&&"none"!=e.node.style.display&&"hidden"!=e.node.style.visibility&&(t.isSource(e)||null!=n&&mxUtils.intersects(e.bounds,n))){var s=t.getGraphX()-e.bounds.getCenterX(),l=t.getGraphY()-e.bounds.getCenterY(),a=s*s+l*l;if(null==i||a<=i)return i=a,!0}return!1}if(null!=this.customHandles&&this.isCustomHandleEvent(t))for(var a=this.customHandles.length-1;a>=0;a--)if(l(this.customHandles[a].shape))return mxEvent.CUSTOM_HANDLE-a;if((t.isSource(this.state.text)||l(this.labelShape))&&(s=mxEvent.LABEL_HANDLE),null!=this.bends)for(a=0;a<this.bends.length;a++)l(this.bends[a])&&(s=a);if(null!=this.virtualBends&&this.isAddVirtualBendEvent(t))for(a=0;a<this.virtualBends.length;a++)l(this.virtualBends[a])&&(s=mxEvent.VIRTUAL_HANDLE-a);return s},mxEdgeHandler.prototype.isAddVirtualBendEvent=function(t){return!0},mxEdgeHandler.prototype.isCustomHandleEvent=function(t){return!0},mxEdgeHandler.prototype.mouseDown=function(t,e){var n=this.getHandleForEvent(e);if(null!=this.bends&&null!=this.bends[n]){var i=this.bends[n].bounds;this.snapPoint=new mxPoint(i.getCenterX(),i.getCenterY())}this.addEnabled&&null==n&&this.isAddPointEvent(e.getEvent())?(this.addPoint(this.state,e.getEvent()),e.consume()):null!=n&&!e.isConsumed()&&this.graph.isEnabled()&&(this.removeEnabled&&this.isRemovePointEvent(e.getEvent())?this.removePoint(this.state,n):(n!=mxEvent.LABEL_HANDLE||this.graph.isLabelMovable(e.getCell()))&&(n<=mxEvent.VIRTUAL_HANDLE&&mxUtils.setOpacity(this.virtualBends[mxEvent.VIRTUAL_HANDLE-n].node,100),this.start(e.getX(),e.getY(),n)),e.consume())},mxEdgeHandler.prototype.start=function(t,e,n){if(this.startX=t,this.startY=e,this.isSource=null!=this.bends&&0==n,this.isTarget=null!=this.bends&&n==this.bends.length-1,this.isLabel=n==mxEvent.LABEL_HANDLE,this.isSource||this.isTarget){var i=this.state.cell,s=this.graph.model.getTerminal(i,this.isSource);(null==s&&this.graph.isTerminalPointMovable(i,this.isSource)||null!=s&&this.graph.isCellDisconnectable(i,s,this.isSource))&&(this.index=n)}else this.index=n;if(this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE&&null!=this.customHandles)for(var l=0;l<this.customHandles.length;l++)l!=mxEvent.CUSTOM_HANDLE-this.index&&this.customHandles[l].setVisible(!1)},mxEdgeHandler.prototype.clonePreviewState=function(t,e){return this.state.clone()},mxEdgeHandler.prototype.getSnapToTerminalTolerance=function(){return this.graph.gridSize*this.graph.view.scale/2},mxEdgeHandler.prototype.updateHint=function(t,e){},mxEdgeHandler.prototype.removeHint=function(){},mxEdgeHandler.prototype.roundLength=function(t){return Math.round(t)},mxEdgeHandler.prototype.isSnapToTerminalsEvent=function(t){return this.snapToTerminals&&!mxEvent.isAltDown(t.getEvent())},mxEdgeHandler.prototype.getPointForEvent=function(t){var e=this.graph.getView(),n=e.scale,i=new mxPoint(this.roundLength(t.getGraphX()/n)*n,this.roundLength(t.getGraphY()/n)*n),s=this.getSnapToTerminalTolerance(),l=!1,a=!1;if(s>0&&this.isSnapToTerminalsEvent(t)){function r(t){if(null!=t){var e=t.x;Math.abs(i.x-e)<s&&(i.x=e,l=!0);var n=t.y;Math.abs(i.y-n)<s&&(i.y=n,a=!0)}}function h(t){null!=t&&r.call(this,new mxPoint(e.getRoutingCenterX(t),e.getRoutingCenterY(t)))}if(h.call(this,this.state.getVisibleTerminalState(!0)),h.call(this,this.state.getVisibleTerminalState(!1)),null!=this.state.absolutePoints)for(var o=0;o<this.state.absolutePoints.length;o++)r.call(this,this.state.absolutePoints[o])}if(this.graph.isGridEnabledEvent(t.getEvent())){var d=e.translate;l||(i.x=(this.graph.snap(i.x/n-d.x)+d.x)*n),a||(i.y=(this.graph.snap(i.y/n-d.y)+d.y)*n)}return i},mxEdgeHandler.prototype.getPreviewTerminalState=function(t){if(this.constraintHandler.update(t,this.isSource,!0,t.isSource(this.marker.highlight.shape)?null:this.currentPoint),null!=this.constraintHandler.currentFocus&&null!=this.constraintHandler.currentConstraint){null!=this.marker.highlight&&null!=this.marker.highlight.state&&this.marker.highlight.state.cell==this.constraintHandler.currentFocus.cell?"transparent"!=this.marker.highlight.shape.stroke&&(this.marker.highlight.shape.stroke="transparent",this.marker.highlight.repaint()):this.marker.markCell(this.constraintHandler.currentFocus.cell,"transparent");var e=this.graph.getModel(),n=this.graph.view.getTerminalPort(this.state,this.graph.view.getState(e.getTerminal(this.state.cell,!this.isSource)),!this.isSource),i=null!=n?n.cell:null,s=this.isSource?this.constraintHandler.currentFocus.cell:i,l=this.isSource?i:this.constraintHandler.currentFocus.cell;this.error=this.validateConnection(s,l);var a=null;return null==this.error&&(a=this.constraintHandler.currentFocus),(null!=this.error||null!=a&&!this.isCellEnabled(a.cell))&&this.constraintHandler.reset(),a}if(this.graph.isIgnoreTerminalEvent(t.getEvent()))return this.marker.reset(),null;this.marker.process(t);var r=this.marker.getValidState();return null==r||this.isCellEnabled(r.cell)||(this.constraintHandler.reset(),this.marker.reset()),this.marker.getValidState()},mxEdgeHandler.prototype.getPreviewPoints=function(t,e){var n,i,s=this.graph.getCellGeometry(this.state.cell),l=null!=s.points?s.points.slice():null,a=new mxPoint(t.x,t.y),r=null;if(this.isSource||this.isTarget)this.graph.resetEdgesOnConnect&&(l=null);else if(this.convertPoint(a,!1),null==l)l=[a];else{if(this.index<=mxEvent.VIRTUAL_HANDLE&&l.splice(mxEvent.VIRTUAL_HANDLE-this.index,0,a),!this.isSource&&!this.isTarget){for(var h=0;h<this.bends.length;h++)if(h!=this.index){var o=this.bends[h];null!=o&&mxUtils.contains(o.bounds,t.x,t.y)&&(this.index<=mxEvent.VIRTUAL_HANDLE?l.splice(mxEvent.VIRTUAL_HANDLE-this.index,1):l.splice(this.index-1,1),r=l)}if(null==r&&this.straightRemoveEnabled&&(null==e||!mxEvent.isAltDown(e.getEvent()))){var d=this.graph.tolerance*this.graph.tolerance,g=this.state.absolutePoints.slice();g[this.index]=t;var u=this.state.getVisibleTerminalState(!0);if(null!=u)null!=(p=this.graph.getConnectionConstraint(this.state,u,!0))&&null!=this.graph.getConnectionPoint(u,p)||(g[0]=new mxPoint(u.view.getRoutingCenterX(u),u.view.getRoutingCenterY(u)));var p,c=this.state.getVisibleTerminalState(!1);if(null!=c)null!=(p=this.graph.getConnectionConstraint(this.state,c,!1))&&null!=this.graph.getConnectionPoint(c,p)||(g[g.length-1]=new mxPoint(c.view.getRoutingCenterX(c),c.view.getRoutingCenterY(c)));n=this.index,i=t,n>0&&n<g.length-1&&mxUtils.ptSegDistSq(g[n-1].x,g[n-1].y,g[n+1].x,g[n+1].y,i.x,i.y)<d&&(l.splice(n-1,1),r=l)}}null==r&&this.index>mxEvent.VIRTUAL_HANDLE&&(l[this.index-1]=a)}return null!=r?r:l},mxEdgeHandler.prototype.isOutlineConnectEvent=function(t){var e=mxUtils.getOffset(this.graph.container),n=t.getEvent(),i=mxEvent.getClientX(n),s=mxEvent.getClientY(n),l=document.documentElement,a=(window.pageXOffset||l.scrollLeft)-(l.clientLeft||0),r=(window.pageYOffset||l.scrollTop)-(l.clientTop||0),h=this.currentPoint.x-this.graph.container.scrollLeft+e.x-a,o=this.currentPoint.y-this.graph.container.scrollTop+e.y-r;return this.outlineConnect&&!mxEvent.isShiftDown(t.getEvent())&&(t.isSource(this.marker.highlight.shape)||mxEvent.isAltDown(t.getEvent())&&null!=t.getState()||this.marker.highlight.isHighlightAt(i,s)||(h!=i||o!=s)&&null==t.getState()&&this.marker.highlight.isHighlightAt(h,o))},mxEdgeHandler.prototype.updatePreviewState=function(t,e,n,i,s){var l=this.isSource?n:this.state.getVisibleTerminalState(!0),a=this.isTarget?n:this.state.getVisibleTerminalState(!1),r=this.graph.getConnectionConstraint(t,l,!0),h=this.graph.getConnectionConstraint(t,a,!1),o=this.constraintHandler.currentConstraint;if(null==o&&s&&(null!=n?(i.isSource(this.marker.highlight.shape)&&(e=new mxPoint(i.getGraphX(),i.getGraphY())),o=this.graph.getOutlineConstraint(e,n,i),this.constraintHandler.setFocus(i,n,this.isSource),this.constraintHandler.currentConstraint=o,this.constraintHandler.currentPoint=e):o=new mxConnectionConstraint),this.outlineConnect&&null!=this.marker.highlight&&null!=this.marker.highlight.shape){var d=this.graph.view.scale;null!=this.constraintHandler.currentConstraint&&null!=this.constraintHandler.currentFocus?(this.marker.highlight.shape.stroke=s?mxConstants.OUTLINE_HIGHLIGHT_COLOR:"transparent",this.marker.highlight.shape.strokewidth=mxConstants.OUTLINE_HIGHLIGHT_STROKEWIDTH/d/d,this.marker.highlight.repaint()):this.marker.hasValidState()&&(this.marker.highlight.shape.stroke=this.graph.isCellConnectable(i.getCell())&&this.marker.getValidState()!=i.getState()?"transparent":mxConstants.DEFAULT_VALID_COLOR,this.marker.highlight.shape.strokewidth=mxConstants.HIGHLIGHT_STROKEWIDTH/d/d,this.marker.highlight.repaint())}this.isSource?r=o:this.isTarget&&(h=o),(this.isSource||this.isTarget)&&(null!=o&&null!=o.point?(t.style[this.isSource?mxConstants.STYLE_EXIT_X:mxConstants.STYLE_ENTRY_X]=o.point.x,t.style[this.isSource?mxConstants.STYLE_EXIT_Y:mxConstants.STYLE_ENTRY_Y]=o.point.y):(delete t.style[this.isSource?mxConstants.STYLE_EXIT_X:mxConstants.STYLE_ENTRY_X],delete t.style[this.isSource?mxConstants.STYLE_EXIT_Y:mxConstants.STYLE_ENTRY_Y])),t.setVisibleTerminalState(l,!0),t.setVisibleTerminalState(a,!1),this.isSource&&null==l||t.view.updateFixedTerminalPoint(t,l,!0,r),this.isTarget&&null==a||t.view.updateFixedTerminalPoint(t,a,!1,h),(this.isSource||this.isTarget)&&null==n&&(t.setAbsoluteTerminalPoint(e,this.isSource),null==this.marker.getMarkedState()&&(this.error=this.graph.allowDanglingEdges?null:"")),t.view.updatePoints(t,this.points,l,a),t.view.updateFloatingTerminalPoints(t,l,a)},mxEdgeHandler.prototype.mouseMove=function(t,e){if(null!=this.index&&null!=this.marker){if(this.currentPoint=this.getPointForEvent(e),this.error=null,!this.graph.isIgnoreTerminalEvent(e.getEvent())&&mxEvent.isShiftDown(e.getEvent())&&null!=this.snapPoint&&(Math.abs(this.snapPoint.x-this.currentPoint.x)<Math.abs(this.snapPoint.y-this.currentPoint.y)?this.currentPoint.x=this.snapPoint.x:this.currentPoint.y=this.snapPoint.y),this.index<=mxEvent.CUSTOM_HANDLE&&this.index>mxEvent.VIRTUAL_HANDLE)null!=this.customHandles&&(this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].processEvent(e),this.customHandles[mxEvent.CUSTOM_HANDLE-this.index].positionChanged());else if(this.isLabel)this.label.x=this.currentPoint.x,this.label.y=this.currentPoint.y;else{this.points=this.getPreviewPoints(this.currentPoint,e);var n=this.graph.isConnectable()&&(this.isSource||this.isTarget)?this.getPreviewTerminalState(e):null;if(null!=this.constraintHandler.currentConstraint&&null!=this.constraintHandler.currentFocus&&null!=this.constraintHandler.currentPoint)this.currentPoint=this.constraintHandler.currentPoint.clone();else if(this.outlineConnect&&this.graph.isConnectable()){var i=!(!this.isSource&&!this.isTarget)&&this.isOutlineConnectEvent(e);i?n=this.marker.highlight.state:null!=n&&n!=e.getState()&&this.graph.isCellConnectable(e.getCell())&&null!=this.marker.highlight.shape&&(this.marker.highlight.shape.stroke="transparent",this.marker.highlight.repaint(),n=null)}null==n||this.isCellEnabled(n.cell)||(n=null,this.marker.reset());var s=this.clonePreviewState(this.currentPoint,null!=n?n.cell:null);this.updatePreviewState(s,this.currentPoint,n,e,i);var l=null==this.error?this.marker.validColor:this.marker.invalidColor;this.setPreviewColor(l),this.abspoints=s.absolutePoints,this.active=!0,this.updateHint(e,this.currentPoint)}this.drawPreview(),mxEvent.consume(e.getEvent()),e.consume()}},mxEdgeHandler.prototype.mouseUp=function(t,e){if(null!=this.index&&null!=this.marker){var n=this.state.cell,i=this.index;if(this.index=null,e.getX()!=this.startX||e.getY()!=this.startY){var s=!this.graph.isIgnoreTerminalEvent(e.getEvent())&&this.graph.isCloneEvent(e.getEvent())&&this.cloneEnabled&&this.graph.isCellsCloneable();if(null!=this.error)this.error.length>0&&this.graph.validationAlert(this.error);else if(i<=mxEvent.CUSTOM_HANDLE&&i>mxEvent.VIRTUAL_HANDLE){if(null!=this.customHandles){(a=this.graph.getModel()).beginUpdate();try{this.customHandles[mxEvent.CUSTOM_HANDLE-i].execute(e)}finally{a.endUpdate()}}}else if(this.isLabel)this.moveLabel(this.state,this.label.x,this.label.y);else if(this.isSource||this.isTarget){var l=null;if(null!=this.constraintHandler.currentConstraint&&null!=this.constraintHandler.currentFocus&&(l=this.constraintHandler.currentFocus.cell),null==l&&this.marker.hasValidState()&&null!=this.marker.highlight&&null!=this.marker.highlight.shape&&"transparent"!=this.marker.highlight.shape.stroke&&"white"!=this.marker.highlight.shape.stroke&&(l=this.marker.validState.cell),null!=l){var a,r=(a=this.graph.getModel()).getParent(n);a.beginUpdate();try{if(s){var h=a.getGeometry(n);s=this.graph.cloneCell(n);a.add(r,s,a.getChildCount(r)),null!=h&&(h=h.clone(),a.setGeometry(s,h));var o=a.getTerminal(n,!this.isSource);this.graph.connectCell(s,o,!this.isSource),n=s}n=this.connect(n,l,this.isSource,s,e)}finally{a.endUpdate()}}else if(this.graph.isAllowDanglingEdges()){var d=this.abspoints[this.isSource?0:this.abspoints.length-1];d.x=this.roundLength(d.x/this.graph.view.scale-this.graph.view.translate.x),d.y=this.roundLength(d.y/this.graph.view.scale-this.graph.view.translate.y);var g=this.graph.getView().getState(this.graph.getModel().getParent(n));null!=g&&(d.x-=g.origin.x,d.y-=g.origin.y),d.x-=this.graph.panDx/this.graph.view.scale,d.y-=this.graph.panDy/this.graph.view.scale,n=this.changeTerminalPoint(n,d,this.isSource,s)}}else this.active?n=this.changePoints(n,this.points,s):(this.graph.getView().invalidate(this.state.cell),this.graph.getView().validate(this.state.cell))}else this.graph.isToggleEvent(e.getEvent())&&this.graph.selectCellForEvent(this.state.cell,e.getEvent());null!=this.marker&&(this.reset(),n!=this.state.cell&&this.graph.setSelectionCell(n)),e.consume()}},mxEdgeHandler.prototype.reset=function(){if(this.active&&this.refresh(),this.error=null,this.index=null,this.label=null,this.points=null,this.snapPoint=null,this.isLabel=!1,this.isSource=!1,this.isTarget=!1,this.active=!1,this.livePreview&&null!=this.sizers)for(var t=0;t<this.sizers.length;t++)null!=this.sizers[t]&&(this.sizers[t].node.style.display="");if(null!=this.marker&&this.marker.reset(),null!=this.constraintHandler&&this.constraintHandler.reset(),null!=this.customHandles)for(t=0;t<this.customHandles.length;t++)this.customHandles[t].reset();this.setPreviewColor(mxConstants.EDGE_SELECTION_COLOR),this.removeHint(),this.redraw()},mxEdgeHandler.prototype.setPreviewColor=function(t){null!=this.shape&&(this.shape.stroke=t)},mxEdgeHandler.prototype.convertPoint=function(t,e){var n=this.graph.getView().getScale(),i=this.graph.getView().getTranslate();e&&(t.x=this.graph.snap(t.x),t.y=this.graph.snap(t.y)),t.x=Math.round(t.x/n-i.x),t.y=Math.round(t.y/n-i.y);var s=this.graph.getView().getState(this.graph.getModel().getParent(this.state.cell));return null!=s&&(t.x-=s.origin.x,t.y-=s.origin.y),t},mxEdgeHandler.prototype.moveLabel=function(t,e,n){var i=this.graph.getModel(),s=i.getGeometry(t.cell);if(null!=s){var l=this.graph.getView().scale;if((s=s.clone()).relative){var a=this.graph.getView().getRelativePoint(t,e,n);s.x=Math.round(1e4*a.x)/1e4,s.y=Math.round(a.y),s.offset=new mxPoint(0,0);a=this.graph.view.getPoint(t,s);s.offset=new mxPoint(Math.round((e-a.x)/l),Math.round((n-a.y)/l))}else{var r=t.absolutePoints,h=r[0],o=r[r.length-1];if(null!=h&&null!=o){var d=h.x+(o.x-h.x)/2,g=h.y+(o.y-h.y)/2;s.offset=new mxPoint(Math.round((e-d)/l),Math.round((n-g)/l)),s.x=0,s.y=0}}i.setGeometry(t.cell,s)}},mxEdgeHandler.prototype.connect=function(t,e,n,i,s){var l=this.graph.getModel();l.getParent(t);l.beginUpdate();try{var a=this.constraintHandler.currentConstraint;null==a&&(a=new mxConnectionConstraint),this.graph.connectCell(t,e,n,a)}finally{l.endUpdate()}return t},mxEdgeHandler.prototype.changeTerminalPoint=function(t,e,n,i){var s=this.graph.getModel();s.beginUpdate();try{if(i){var l=s.getParent(t),a=s.getTerminal(t,!n);t=this.graph.cloneCell(t),s.add(l,t,s.getChildCount(l)),s.setTerminal(t,a,!n)}var r=s.getGeometry(t);null!=r&&((r=r.clone()).setTerminalPoint(e,n),s.setGeometry(t,r),this.graph.connectCell(t,null,n,new mxConnectionConstraint))}finally{s.endUpdate()}return t},mxEdgeHandler.prototype.changePoints=function(t,e,n){var i=this.graph.getModel();i.beginUpdate();try{if(n){var s=i.getParent(t),l=i.getTerminal(t,!0),a=i.getTerminal(t,!1);t=this.graph.cloneCell(t),i.add(s,t,i.getChildCount(s)),i.setTerminal(t,l,!0),i.setTerminal(t,a,!1)}var r=i.getGeometry(t);null!=r&&((r=r.clone()).points=e,i.setGeometry(t,r))}finally{i.endUpdate()}return t},mxEdgeHandler.prototype.addPoint=function(t,e){var n=mxUtils.convertPoint(this.graph.container,mxEvent.getClientX(e),mxEvent.getClientY(e)),i=this.graph.isGridEnabledEvent(e);this.convertPoint(n,i),this.addPointAt(t,n.x,n.y),mxEvent.consume(e)},mxEdgeHandler.prototype.addPointAt=function(t,e,n){var i=this.graph.getCellGeometry(t.cell),s=new mxPoint(e,n);if(null!=i){i=i.clone();var l=this.graph.view.translate,a=this.graph.view.scale,r=new mxPoint(l.x*a,l.y*a),h=this.graph.model.getParent(this.state.cell);if(this.graph.model.isVertex(h)){var o=this.graph.view.getState(h);r=new mxPoint(o.x,o.y)}var d=mxUtils.findNearestSegment(t,s.x*a+r.x,s.y*a+r.y);null==i.points?i.points=[s]:i.points.splice(d,0,s),this.graph.getModel().setGeometry(t.cell,i),this.refresh(),this.redraw()}},mxEdgeHandler.prototype.removePoint=function(t,e){if(e>0&&e<this.abspoints.length-1){var n=this.graph.getCellGeometry(this.state.cell);null!=n&&null!=n.points&&((n=n.clone()).points.splice(e-1,1),this.graph.getModel().setGeometry(t.cell,n),this.refresh(),this.redraw())}},mxEdgeHandler.prototype.getHandleFillColor=function(t){var e=0==t,n=this.state.cell,i=this.graph.getModel().getTerminal(n,e),s=mxConstants.HANDLE_FILLCOLOR;return null!=i&&!this.graph.isCellDisconnectable(n,i,e)||null==i&&!this.graph.isTerminalPointMovable(n,e)?s=mxConstants.LOCKED_HANDLE_FILLCOLOR:null!=i&&this.graph.isCellDisconnectable(n,i,e)&&(s=mxConstants.CONNECT_HANDLE_FILLCOLOR),s},mxEdgeHandler.prototype.redraw=function(t){this.abspoints=this.state.absolutePoints.slice();var e=this.graph.getModel().getGeometry(this.state.cell);if(null!=e){var n=e.points;if(null!=this.bends&&this.bends.length>0&&null!=n){null==this.points&&(this.points=[]);for(var i=1;i<this.bends.length-1;i++)null!=this.bends[i]&&null!=this.abspoints[i]&&(this.points[i-1]=n[i-1])}}this.drawPreview(),t||this.redrawHandles()},mxEdgeHandler.prototype.redrawHandles=function(){var t=this.state.cell,e=this.labelShape.bounds;this.label=new mxPoint(this.state.absoluteOffset.x,this.state.absoluteOffset.y),this.labelShape.bounds=new mxRectangle(Math.round(this.label.x-e.width/2),Math.round(this.label.y-e.height/2),e.width,e.height);var n=this.graph.getLabel(t);if(this.labelShape.visible=null!=n&&n.length>0&&this.graph.isLabelMovable(t),null!=this.bends&&this.bends.length>0){var i=this.abspoints.length-1,s=this.abspoints[0],l=s.x,a=s.y;e=this.bends[0].bounds,this.bends[0].bounds=new mxRectangle(Math.floor(l-e.width/2),Math.floor(a-e.height/2),e.width,e.height),this.bends[0].fill=this.getHandleFillColor(0),this.bends[0].redraw(),this.manageLabelHandle&&this.checkLabelHandle(this.bends[0].bounds);var r=this.abspoints[i],h=r.x,o=r.y,d=this.bends.length-1;e=this.bends[d].bounds,this.bends[d].bounds=new mxRectangle(Math.floor(h-e.width/2),Math.floor(o-e.height/2),e.width,e.height),this.bends[d].fill=this.getHandleFillColor(d),this.bends[d].redraw(),this.manageLabelHandle&&this.checkLabelHandle(this.bends[d].bounds),this.redrawInnerBends(s,r)}if(null!=this.abspoints&&null!=this.virtualBends&&this.virtualBends.length>0)for(var g=this.abspoints[0],u=0;u<this.virtualBends.length;u++)if(null!=this.virtualBends[u]&&null!=this.abspoints[u+1]){var p=this.abspoints[u+1],c=(e=this.virtualBends[u],g.x+(p.x-g.x)/2),m=g.y+(p.y-g.y)/2;e.bounds=new mxRectangle(Math.floor(c-e.bounds.width/2),Math.floor(m-e.bounds.height/2),e.bounds.width,e.bounds.height),e.redraw(),mxUtils.setOpacity(e.node,this.virtualBendOpacity),g=p,this.manageLabelHandle&&this.checkLabelHandle(e.bounds)}if(null!=this.labelShape&&this.labelShape.redraw(),null!=this.customHandles)for(u=0;u<this.customHandles.length;u++){var E=this.customHandles[u].shape.node.style.display;this.customHandles[u].redraw(),this.customHandles[u].shape.node.style.display=E,this.customHandles[u].shape.node.style.visibility=this.isCustomHandleVisible(this.customHandles[u])?"":"hidden"}},mxEdgeHandler.prototype.isCustomHandleVisible=function(t){return!this.graph.isEditing()&&1==this.state.view.graph.getSelectionCount()},mxEdgeHandler.prototype.setHandlesVisible=function(t){if(null!=this.bends)for(var e=0;e<this.bends.length;e++)this.bends[e].node.style.display=t?"":"none";if(null!=this.virtualBends)for(e=0;e<this.virtualBends.length;e++)this.virtualBends[e].node.style.display=t?"":"none";if(null!=this.labelShape&&(this.labelShape.node.style.display=t?"":"none"),null!=this.customHandles)for(e=0;e<this.customHandles.length;e++)this.customHandles[e].setVisible(t)},mxEdgeHandler.prototype.redrawInnerBends=function(t,e){for(var n=1;n<this.bends.length-1;n++)if(null!=this.bends[n])if(null!=this.abspoints[n]){var i=this.abspoints[n].x,s=this.abspoints[n].y,l=this.bends[n].bounds;this.bends[n].node.style.visibility="visible",this.bends[n].bounds=new mxRectangle(Math.round(i-l.width/2),Math.round(s-l.height/2),l.width,l.height),this.manageLabelHandle?this.checkLabelHandle(this.bends[n].bounds):null==this.handleImage&&this.labelShape.visible&&mxUtils.intersects(this.bends[n].bounds,this.labelShape.bounds)&&(w=mxConstants.HANDLE_SIZE+3,h=mxConstants.HANDLE_SIZE+3,this.bends[n].bounds=new mxRectangle(Math.round(i-w/2),Math.round(s-h/2),w,h)),this.bends[n].redraw()}else this.bends[n].destroy(),this.bends[n]=null},mxEdgeHandler.prototype.checkLabelHandle=function(t){if(null!=this.labelShape){var e=this.labelShape.bounds;mxUtils.intersects(t,e)&&(t.getCenterY()<e.getCenterY()?e.y=t.y+t.height:e.y=t.y-e.height)}},mxEdgeHandler.prototype.drawPreview=function(){if(this.isLabel){var t=this.labelShape.bounds,e=new mxRectangle(Math.round(this.label.x-t.width/2),Math.round(this.label.y-t.height/2),t.width,t.height);this.labelShape.bounds.equals(e)||(this.labelShape.bounds=e,this.labelShape.redraw())}null==this.shape||mxUtils.equalPoints(this.shape.points,this.abspoints)||(this.shape.apply(this.state),this.shape.points=this.abspoints.slice(),this.shape.scale=this.state.view.scale,this.shape.isDashed=this.isSelectionDashed(),this.shape.stroke=this.getSelectionColor(),this.shape.strokewidth=this.getSelectionStrokeWidth()/this.shape.scale/this.shape.scale,this.shape.isShadow=!1,this.shape.redraw()),null!=this.parentHighlight&&this.parentHighlight.redraw()},mxEdgeHandler.prototype.refresh=function(){this.abspoints=this.getSelectionPoints(this.state),this.points=[],null!=this.bends&&(this.destroyBends(this.bends),this.bends=this.createBends()),null!=this.virtualBends&&(this.destroyBends(this.virtualBends),this.virtualBends=this.createVirtualBends()),null!=this.customHandles&&(this.destroyBends(this.customHandles),this.customHandles=this.createCustomHandles()),null!=this.labelShape&&null!=this.labelShape.node&&null!=this.labelShape.node.parentNode&&this.labelShape.node.parentNode.appendChild(this.labelShape.node)},mxEdgeHandler.prototype.destroyBends=function(t){if(null!=t)for(var e=0;e<t.length;e++)null!=t[e]&&t[e].destroy()},mxEdgeHandler.prototype.destroy=function(){null!=this.escapeHandler&&(this.state.view.graph.removeListener(this.escapeHandler),this.escapeHandler=null),null!=this.marker&&(this.marker.destroy(),this.marker=null),null!=this.shape&&(this.shape.destroy(),this.shape=null),null!=this.parentHighlight&&(this.parentHighlight.destroy(),this.parentHighlight=null),null!=this.labelShape&&(this.labelShape.destroy(),this.labelShape=null),null!=this.constraintHandler&&(this.constraintHandler.destroy(),this.constraintHandler=null),this.destroyBends(this.virtualBends),this.virtualBends=null,this.destroyBends(this.customHandles),this.customHandles=null,this.destroyBends(this.bends),this.bends=null,this.removeHint()};